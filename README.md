
---

# 🚀 启智-Hephaestus 深度学习科研自动化工作流

**版本：1.0 (W&B & Venv 安全固化版)**

## 核心理念：本地创意，云端调度，常驻代理同步结果

本工作流旨在将人类研究员（PI）的精力完全解放出来，专注于**理论推导和深度科学解读**。所有工程、环境和数据同步工作均由 AI 和自动化系统完成，同时满足启智平台安全规范。

---

## 👨‍💻 AI 团队角色与职责

| 角色 | 核心职责 | 启智平台侧重 |
| :--- | :--- | :--- |
| **您 (PI)** | 战略家、**理论推导**、最终决策和科学解读。 | 专注于 W&B Run URL 上的交互式深度分析。 |
| **`Gemini CLI` (首席科学家)** | 规划设计、生成结构化任务、**知识沉淀**。 | 确保 `QWEN_TASK` 包含正确的启智 API 参数和基础镜像名称。 |
| **`Qwen Code` (全栈执行官)** | 代码编写、原生 PR 提交、**Venv 环境固化**、API 网关。 | 在可上网区创建**自包含的 `uv venv`**，并构造激活 Venv 的启动命令。 |
| **`Qizhi Sync Agent`** | **常驻服务**（在可上网区运行），负责监控共享目录并**自动执行 W&B 离线同步**。 | 是唯一与 W&B Cloud 进行公网同步的实体。 |

---

## I. 工作流的三大循环

### **第一环（本地）：创世纪与环境固化循环**

**目标：** 将科学想法转化为包含代码、**自包含 Venv 环境**和 W&B 离线配置的 Pull Request。

| 步骤 | 细节描述 | 核心产出 |
| :--- | :--- | :--- |
| **1.1 规划与设计 (PI ↔️ Gemini)** | PI 提出 idea，`Gemini` 生成结构化的 `QWEN_TASK` 笔记，内容包括：代码变更、实验启动命令、**启智平台基础镜像名称**、所需资源规格、以及 W&B 离线配置指令。 | `QWEN_TASK` 笔记。 |
| **1.2 编码与 Venv 固化 (`Qwen` 升级)** | `Qwen` **在可上网区（共享文件目录）**内： 1. 编写代码，并配置 W&B 设置为 `mode="offline"`。 2. 使用 `uv venv .venv` 在项目目录下创建**自包含的 Python 环境**，并将所有依赖包安装到此目录。 3. **清除缓存**，确保 `.venv` 具有完整可移植性。 | 训练代码和位于共享目录的 **`.venv` 文件夹**。 |
| **1.3 PR 原生创建 (`Qwen`)** | `Qwen` 调用 `/mcp__github__create_pull_request` 原生工具，提交代码和环境配置。 | **Pull Request (PR)**。 |

### **第二环（云端）：原生自动化质量保证循环**

**目标：** 在动用计算资源之前，对 PR 提交的代码和环境配置进行严格审查。

| 步骤 | 细节描述 | 关键检查点 |
| :--- | :--- | :--- |
| **2.2 并行审查作业** | **Copilot (审查官):** 依据指令，审查代码逻辑、架构、W&B 离线配置是否正确。 **静态分析:** 检查代码风格、依赖兼容性等。 | **代码架构**和 W&B 离线模式配置的正确性。 |

### **第三环（云端→不可联网区）：异步执行与 W&B 安全同步循环**

**目标：** 安全地启动不可联网区的训练任务，并利用常驻代理实现 W&B 数据同步。

| 步骤 | 执行者 | 优化后的操作细节 | 启智 API / 工具 |
| :--- | :--- | :--- | :--- |
| **3.2 自动化训练任务创建** | Actions (云端) | 1. **鉴权：** 调用 `https://qz.sii.edu.cn/auth/token` 获取 Bearer Token。 2. **构造命令：** 构造 Venv 激活命令：`source .venv/bin/activate && python train.py ...`。 3. **创建任务：** 调用 `https://qz.sii.edu.cn/openapi/v1/train_job/create`。 **关键参数：** `framework_config.image` 使用基础镜像；`command` 使用 Venv 激活命令。 | **Create API**。 |
| **3.3 异步状态监测** | Actions (云端) | 进入 **Poll Loop**，周期性调用 `https://qz.sii.edu.cn/openapi/v1/train_job/detail`，监测任务状态直到 `COMPLETED`。 | **Detail API**。 |
| **3.4 W&B 离线同步 (Qizhi Agent)** | **Qizhi Sync Agent** (可上网区) | 任务完成后，常驻代理自动检测共享目录中的 W&B 离线日志，并立即执行 **`wandb sync`**，将数据推送到 W&B Cloud。 | W&B CLI。 |
| **3.5 结果回收与展示** | Actions (云端) | 1. **下载产物：** Actions 直接通过 **W&B Public API/SDK** 从 W&B Cloud 下载关键指标图（如损失曲线）。 2. **PR 回传：** Actions 在 PR 评论中嵌入图片和**可供交互的 W&B Run URL**。 | W&B API，GitHub API。 |

### **第四环（本地）：决策、集成与知识沉淀**

| 步骤 | 细节描述 | 核心产出 |
| :--- | :--- | :--- |
| **4.1 最终分析与决策 (PI ↔️ Gemini)** | PI 围绕 W&B 图表和 URL 进行深度科学讨论，下达合并指令。 | 最终科学结论。 |
| **4.2 原生 PR 合并 (`Qwen`)** | `Qwen` 调用 `/mcp__github__merge_pull_request` 原生工具，使用 `squash` 合并。 | 验证过的代码原子性合并。 |
| **4.3 知识的最终沉淀 (`Gemini`)** | PR 合并成功后，`Gemini` 自动创建永久性的、**Hephaestus-Zettelkasten** 结构化总结笔记，包含：**启智 `job_id`**，**W&B Run URL**，**实验配置**和**核心科学结论**。 | **永久知识笔记**。 |
